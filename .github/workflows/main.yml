name: Secret Cleanup Automation
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  scan-and-remove:
    if: contains(github.event.issue.labels.*.name, 'secrets-cleanup')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history is required

      - name: Backup repo
        run: |
          git clone --mirror https://github.com/${{ github.repository }} backup.git
          echo "✅ Backup created in backup.git"

      - name: Install BFG Cleaner
        run: |
          wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
          mv bfg-1.14.0.jar bfg.jar

      - name: Create secrets file
        run: |
          echo "${{ github.event.issue.body }}" > secrets-to-remove.txt

      - name: Clean secrets using BFG
        run: |
          java -jar bfg.jar --replace-text secrets-to-remove.txt
          git reflog expire --expire=now --all
          git gc --prune=now --aggressive

      - name: Force push cleaned history
        run: |
          git push origin --force --all
          git push origin --force --tags

      - name: Validate secret removal
        run: |
          git grep -I -E '(password|secret|token|api[_-]?key)' || echo "✅ No secrets found post-cleanup"

      - name: Notify team
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: "✅ Secrets have been removed from Git history.\n\n⚠️ **Action Required:** All developers must delete their local repo and reclone.\n\nA backup is available in the `backup.git` folder of this workflow run."
            })
