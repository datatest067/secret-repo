name: Secret Removal
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  secret-removal:
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, '[Secret-Removal]')
    env:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      TEMP_DIR: /tmp/secret-removal

    steps:
      # Step 1: Parse form inputs from the issue body - SIMPLIFIED
      - name: Parse form inputs from issue body
        id: parse
        run: |
          echo "ðŸ” Raw ISSUE_BODY:"
          echo "${{ github.event.issue.body }}"
          echo "------------------------------"
          
          # Use grep to extract values - much simpler and more reliable
          GH_REPO="secret-repo"
          GH_ORG="datatest067"

          
          # Print for debug
          echo "GH_REPO=$GH_REPO"
          echo "GH_ORG=$GH_ORG"
          
          # Validate input
          if [ -z "$GH_REPO" ] || [ -z "$GH_ORG" ]; then
            echo "âŒ One or more required values are missing"
            exit 1
          fi
          
          # Set outputs for use in other steps
          echo "gh_repo=$GH_REPO" >> $GITHUB_OUTPUT
          echo "gh_org=$GH_ORG" >> $GITHUB_OUTPUT
          
          # Create working directory
          mkdir -p $TEMP_DIR
          
      - name: Install tools
        run: |
          sudo apt update && sudo apt install -y gh jq openjdk-11-jre-headless zip wget
          wget -O $TEMP_DIR/bfg.jar https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
          echo -e '#!/bin/bash\njava -jar $TEMP_DIR/bfg.jar "$@"' > $TEMP_DIR/bfg && chmod +x $TEMP_DIR/bfg
          sudo mv $TEMP_DIR/bfg /usr/local/bin/bfg

      - name: Authenticate with GitHub CLI
        run: echo "$PAT_TOKEN" | gh auth login --with-token

      - name: Get default branch & disable protection
        run: |
          ORG=${{ steps.setup.outputs.gh_org }}
          REPO=${{ steps.setup.outputs.gh_repo }}
          DEFAULT_BRANCH=$(gh api "/repos/$ORG/$REPO" | jq -r '.default_branch')
          echo "Default branch: $DEFAULT_BRANCH"
          gh api "/repos/$ORG/$REPO/branches/$DEFAULT_BRANCH/protection" > $TEMP_DIR/branch_protection.json || echo '{}' > $TEMP_DIR/branch_protection.json
          curl -s -X DELETE -H "Authorization: token $PAT_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$ORG/$REPO/branches/$DEFAULT_BRANCH/protection"

      - name: Clone repo & backup
        run: |
          ORG=${{ steps.setup.outputs.gh_org }}
          REPO=${{ steps.setup.outputs.gh_repo }}
          BACKUP_DIR="$TEMP_DIR/backup-$REPO"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone --mirror "https://$PAT_TOKEN@github.com/$ORG/$REPO.git" "$BACKUP_DIR/repo"
          rm -f "$BACKUP_DIR/repo/config" && touch "$BACKUP_DIR/repo/config"
          zip -r "$TEMP_DIR/artifacts/$REPO-backup.zip" "$BACKUP_DIR"

      - name: Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.gh_repo }}-backup
          path: ${{ env.TEMP_DIR }}/artifacts/${{ steps.setup.outputs.gh_repo }}-backup.zip

      - name: Secret scanning report
        run: |
          ORG=${{ steps.setup.outputs.gh_org }}
          REPO=${{ steps.setup.outputs.gh_repo }}
          mkdir -p $TEMP_DIR/reports
          gh api "/repos/$ORG/$REPO/secret-scanning/alerts?state=open&per_page=100" > $TEMP_DIR/reports/alerts.json || echo "[]" > $TEMP_DIR/reports/alerts.json
          jq -r '.[].secret' $TEMP_DIR/reports/alerts.json > $TEMP_DIR/reports/exact_secrets.txt || echo "" > $TEMP_DIR/reports/exact_secrets.txt

      - name: Upload secret report
        uses: actions/upload-artifact@v4
        with:
          name: secrets-detected-report
          path: ${{ env.TEMP_DIR }}/reports/alerts.json

      - name: Purge secrets using BFG
        run: |
          echo "***REMOVED***" > $TEMP_DIR/patterns.txt
          cat $TEMP_DIR/reports/exact_secrets.txt | sed 's/[.*+?^${}()|[\\]\/]/\\&/g' >> $TEMP_DIR/patterns.txt
          bfg --replace-text $TEMP_DIR/patterns.txt --no-blob-protection .
          git reflog expire --expire=now --all && git gc --prune=now --aggressive

      - name: Force push cleaned repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git push origin --all --force
          git push origin --tags --force

      - name: Comment and close issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MSG="âœ… Secret removal process completed. Check artifacts for backup and report."
          gh issue comment ${{ github.event.issue.number }} --body "$MSG"
          gh issue close ${{ github.event.issue.number }}

      - name: Restore branch protection
        run: |
          ORG=${{ steps.setup.outputs.gh_org }}
          REPO=${{ steps.setup.outputs.gh_repo }}
          DEFAULT_BRANCH=$(gh api "/repos/$ORG/$REPO" | jq -r '.default_branch')
          PROTECTION=$(cat $TEMP_DIR/branch_protection.json)
          if [ "$PROTECTION" != "{}" ]; then
            echo "$PROTECTION" | curl -s -X PUT -H "Authorization: token $PAT_TOKEN" -H "Accept: application/vnd.github+json" -d @- "https://api.github.com/repos/$ORG/$REPO/branches/$DEFAULT_BRANCH/protection"
          fi

      - name: Clean up
        if: always()
        run: rm -rf $TEMP_DIR $GITHUB_WORKSPACE/*-backup.zip $GITHUB_WORKSPACE/*.jar $GITHUB_WORKSPACE/backup-* $GITHUB_WORKSPACE/*.json
