name: Secret Cleanup on PR Open

on:
  pull_request:
    types: [opened]

jobs:
  scan-and-remove:
    # Run only if the PR has the 'secrets-cleanup' label
    if: contains(join(github.event.pull_request.labels.*.name, ','), 'secrets-cleanup')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install BFG
        run: |
          wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
          mv bfg-1.14.0.jar bfg.jar

      - name: Create secrets list from PR description
        run: |
          echo "${{ github.event.pull_request.body }}" > secrets-to-remove.txt

      - name: Run BFG cleanup
        run: |
          java -jar bfg.jar --replace-text secrets-to-remove.txt
          git reflog expire --expire=now --all
          git gc --prune=now --aggressive

      - name: Force push cleaned history
        run: |
          git push origin --force --all
          git push origin --force --tags

      - name: Notify cleanup complete
        run: echo "✅ Cleanup complete — please reclone the repository."
