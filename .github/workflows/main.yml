name: Purge Secrets on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write

jobs:
  purge-***REMOVED***s:
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.repository }}
      BACKUP_DIR: backup-$REPO_NAME
      PAT_TOKEN: ${{ ***REMOVED***s.PAT_TOKEN }}

    steps:
      - name: Checkout repo with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install BFG
        run: |
          sudo apt-get update && sudo apt-get install -y openjdk-11-jre-headless
          wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
          sudo mv bfg-1.14.0.jar /usr/local/bin/bfg.jar
          echo -e '#!/bin/bash\njava -jar /usr/local/bin/bfg.jar "$@"' | sudo tee /usr/local/bin/bfg > /dev/null
          sudo chmod +x /usr/local/bin/bfg

      - name: Clone repo with all refs
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone --mirror https://$PAT_TOKEN@github.com/${REPO_NAME}.git repo.git

      - name: Convert bare repo to working
        run: |
          cd repo.git
          git config --bool core.bare false
          git reset --hard
          git clean -fd

      - name: Copy ***REMOVED***s pattern file
        run: |
          cp .github/***REMOVED***s-patterns.txt ./***REMOVED***s-patterns.txt

      - name: Clean branches & create PRs
        run: |
          cd repo.git

          for branch in $(git branch -r | grep -vE 'origin/HEAD|origin/cleanup/' | sed 's|origin/||'); do
            CLEAN_BRANCH="cleanup/${branch//\//_}"

            echo "üîß Checking out $branch"
            git checkout -B "$CLEAN_BRANCH" "origin/$branch"

            echo "üßπ Running BFG cleanup..."
            bfg --replace-text ../***REMOVED***s-patterns.txt --no-blob-protection .

            echo "üì¶ Checking for detected ***REMOVED***s..."
            SECRET_COUNT=$(git log -p | grep -c -f ../***REMOVED***s-patterns.txt || true)

            if [[ "$SECRET_COUNT" -eq 0 ]]; then
              echo "‚ÑπÔ∏è No ***REMOVED***s found in $branch ‚Äî skipping."
              continue
            fi

            if git diff --quiet; then
              echo "‚ÑπÔ∏è No changes detected ‚Äî skipping."
              continue
            fi

            echo "üßπ Finalizing cleanup"
            git reflog expire --expire=now --all
            git gc --prune=now --aggressive

            echo "üì§ Pushing $CLEAN_BRANCH"
            git push origin "$CLEAN_BRANCH"

            echo "üîç Checking for existing PR"
            PR_EXISTS=$(curl -s -H "Authorization: ***REMOVED*** $PAT_TOKEN" \
              "https://api.github.com/repos/$REPO_NAME/pulls?head=datatest067:${CLEAN_BRANCH}&base=${branch}" \
              | jq '. | length')

            if [[ "$PR_EXISTS" -gt 0 ]]; then
              echo "üö´ PR already exists for $branch ‚Äî skipping."
              continue
            fi

            echo "üì¨ Creating PR for $branch"
            pr_body=$(jq -n \
              --arg title "[SECRETS-CLEANUP] $branch" \
              --arg head "$CLEAN_BRANCH" \
              --arg base "$branch" \
              --arg body "This pull request contains automated ***REMOVED***s cleanup for **$branch**.\n\nPlease verify." \
              '{
                title: $title,
                head: $head,
                base: $base,
                body: $body,
                labels: ["security", "automated-cleanup"]
              }')

            response=$(curl -s -w "%{http_code}" -o response.json -X POST \
              -H "Authorization: ***REMOVED*** $PAT_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO_NAME/pulls \
              -d "$pr_body")

            if [[ "$response" != "201" ]]; then
              echo "‚ùå Failed to create PR for $branch (HTTP $response)"
              cat response.json
              exit 1
            else
              echo "‚úÖ PR created for $branch"
            fi

            git reset --hard
            git clean -fd

          done
