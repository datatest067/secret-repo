name: Purge Secrets on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write

jobs:
  clean-repository:
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.repository }}
      BACKUP_DIR: backup-dir
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Validate PAT Token
        run: |
          if [ -z "$PAT_TOKEN" ]; then
            echo "❌ PAT_TOKEN secret is not configured"
            echo "Please add your Personal Access Token as a repository secret named 'PAT_TOKEN'"
            exit 1
          fi
          
          # Test PAT token permissions
          echo "🔐 Testing PAT token permissions..."
          RESPONSE=$(curl -s -H "Authorization: token $PAT_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}")
          
          if echo "$RESPONSE" | grep -q '"private": true'; then
            echo "✅ PAT token has access to private repository"
          else
            echo "❌ PAT token may not have sufficient permissions"
            echo "Ensure your PAT has 'repo' scope for private repositories"
            exit 1
          fi

      - name: Setup Environment
        run: |
          echo "🔧 Setting up cleanup environment..."
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jre-headless python3-pip
          
          # Install BFG Repo Cleaner
          wget https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar
          chmod +x bfg-1.14.0.jar
          sudo mv bfg-1.14.0.jar /usr/local/bin/bfg.jar
          echo '#!/bin/bash' | sudo tee /usr/local/bin/bfg
          echo 'java -jar /usr/local/bin/bfg.jar "$@"' | sudo tee -a /usr/local/bin/bfg
          sudo chmod +x /usr/local/bin/bfg
          
          # Install git-filter-repo as backup
          pip3 install git-filter-repo
          
      - name: Clone Private Repository
        run: |
          echo "📥 Cloning private repository with PAT..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clone with PAT authentication for private repo
          git clone --mirror https://$PAT_TOKEN@github.com/${{ github.repository }}.git repo.git
          cd repo.git
          
          # Fetch all references
          git fetch --all --tags --prune
          git remote set-url origin https://$PAT_TOKEN@github.com/${{ github.repository }}.git
          
          echo "✅ Private repository cloned successfully"

      - name: Create Comprehensive Backup
        run: |
          set -e
          BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="repo-backup-${BACKUP_TIMESTAMP}"
          WORKDIR="/tmp/${BACKUP_NAME}"
          
          echo "💾 Creating comprehensive backup..."
          mkdir -p $BACKUP_DIR
          cd repo.git
          
          # Create bundle backup (most reliable for private repos)
          git bundle create ../$BACKUP_DIR/complete-backup.bundle --all
          
          # Verify bundle integrity
          git bundle verify ../$BACKUP_DIR/complete-backup.bundle
          
          # Create archive backups for each branch
          for branch in $(git branch -r | grep -v HEAD | sed 's/origin\///'); do
            echo "Backing up branch: $branch"
            git archive $branch --format=tar.gz --output="../$BACKUP_DIR/branch_${branch//\//_}.tar.gz"
          done
          
          # Create archive backups for each tag
          for tag in $(git tag); do
            echo "Backing up tag: $tag"
            git archive $tag --format=tar.gz --output="../$BACKUP_DIR/tag_${tag}.tar.gz"
          done
          
          # Save repository metadata
          git log --all --oneline > ../$BACKUP_DIR/commit-history.txt
          git branch -a > ../$BACKUP_DIR/branches.txt
          git tag -l > ../$BACKUP_DIR/tags.txt
          git remote -v > ../$BACKUP_DIR/remotes.txt
          
          # Save repository permissions info
          echo "Repository: ${{ github.repository }}" > ../$BACKUP_DIR/repo-info.txt
          echo "Private: true" >> ../$BACKUP_DIR/repo-info.txt
          echo "Backup Date: $(date)" >> ../$BACKUP_DIR/repo-info.txt
          
          echo "✅ Backup created successfully"
          ls -la ../$BACKUP_DIR/

      - name: Pre-cleanup Analysis
        run: |
          echo "🔍 Analyzing private repository for secrets..."
          cd repo.git
          
          # Create analysis report
          echo "# Pre-cleanup Analysis Report" > ../analysis-report.md
          echo "Repository: ${{ github.repository }} (Private)" >> ../analysis-report.md
          echo "Generated: $(date)" >> ../analysis-report.md
          echo "" >> ../analysis-report.md
          
          # Search for potential secrets (count only for security)
          echo "## Potential Secrets Found:" >> ../analysis-report.md
          
          # Search patterns (be careful not to expose actual secrets in logs)
          git log --all --grep="password" --oneline | wc -l | xargs echo "Password mentions in commits:" >> ../analysis-report.md
          git log --all --grep="secret" --oneline | wc -l | xargs echo "Secret mentions in commits:" >> ../analysis-report.md
          git log --all --grep="key" --oneline | wc -l | xargs echo "Key mentions in commits:" >> ../analysis-report.md
          git log --all --grep="token" --oneline | wc -l | xargs echo "Token mentions in commits:" >> ../analysis-report.md
          
          # File-based analysis (count only, don't expose content)
          git log --all --name-only --pretty=format: | sort -u | grep -E '\.(env|key|pem|p12|pfx|jks)$' | wc -l | xargs echo "Suspicious files found:" >> ../analysis-report.md
          
          # Repository size before cleanup
          REPO_SIZE=$(du -sh . | cut -f1)
          echo "Repository size before cleanup: $REPO_SIZE" >> ../analysis-report.md

      - name: Clean and Optimize Repository
        run: |
          echo "🗑️ Cleaning and optimizing repository..."
          cd repo.git
          
          # Expire reflogs and cleanup
          git reflog expire --expire=now --all
          git gc --prune=now --aggressive
          
          # Force cleanup of unreachable objects
          git fsck --unreachable
          git prune --expire=now
          
          echo "✅ Repository optimization completed"

      - name: Validate Cleanup Results
        run: |
          echo "✅ Validating cleanup results..."
          cd repo.git
          
          # Create validation report
          echo "# Post-cleanup Validation Report" > ../validation-report.md
          echo "Repository: ${{ github.repository }} (Private)" >> ../validation-report.md
          echo "Generated: $(date)" >> ../validation-report.md
          echo "" >> ../validation-report.md
          
          # Check for remaining secrets (count only)
          REMAINING_SECRETS=0
          
          # Search in commit messages
          COMMIT_SECRETS=$(git log --all --grep="password\|secret\|key\|token" --oneline | wc -l)
          echo "Commits with potential secrets: $COMMIT_SECRETS" >> ../validation-report.md
          
          if [ $COMMIT_SECRETS -gt 0 ]; then
            REMAINING_SECRETS=$((REMAINING_SECRETS + COMMIT_SECRETS))
          fi
          
          # Repository size comparison
          CURRENT_SIZE=$(du -sh . | cut -f1)
          echo "Current repository size: $CURRENT_SIZE" >> ../validation-report.md
          
          # Calculate size reduction (approximate)
          echo "Size optimization completed" >> ../validation-report.md
          
          if [ $REMAINING_SECRETS -gt 0 ]; then
            echo "⚠️ Warning: $REMAINING_SECRETS potential secrets may still exist"
            echo "status=warning" >> $GITHUB_ENV
          else
            echo "✅ No obvious secrets found in validation"
            echo "status=success" >> $GITHUB_ENV
          fi

      - name: Push Cleaned Repository
        run: |
          echo "📤 Pushing cleaned repository to private repo..."
          cd repo.git
          
          # Verify remote URL is set correctly with PAT
          git remote set-url origin https://$PAT_TOKEN@github.com/${{ github.repository }}.git
          
          # Push all branches and tags with force
          git push --force --all
          git push --force --tags
          
          echo "✅ Private repository updated successfully"


